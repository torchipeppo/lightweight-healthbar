<!DOCTYPE html>
<html>
    <head>
        <title>Lightweight Healthbars</title>
        <link rel='icon' type='image/ico' href='./favicon.ico'/>
        <meta name="viewport" content="width = 320" />
        <style>
            progress.hp { accent-color: green; }
            progress.hp-crisis { accent-color: red; }
            progress.mp { accent-color: blue; }

            input.three-digits { width:4em; }
            
            .healthbar-spread {
                width: auto;
                max-width: 40em;
            }
            .healthbar-spread .left {
                width: auto;
                overflow: hidden;
            }
            .healthbar-spread .right {
                width: auto;
                padding-left: 10px;
                padding-right: 10px;
                float: right;
            }
            .healthbar-spread progress { width: 100%; }
        </style>
        <script>
            function setFromLocalStorageIfNotNull(item, callback) {
                const val = window.localStorage.getItem(item);
                if (val != null) {
                    callback(val);
                }
            }
            function onLoad() {
                const hpbar = getHpBar();
                const mpbar = getMpBar();
                window.allowLocalStorage = window.localStorage.getItem("allowLocalStorage");
                if (window.allowLocalStorage) {
                    onAllow();
                    setFromLocalStorageIfNotNull("hp", (hp)=>{
                        hpbar.setAttribute("value", hp);
                        document.getElementById("hp-field").value = hp;
                    });
                    setFromLocalStorageIfNotNull("maxhp", (maxhp)=>{
                        hpbar.setAttribute("max", maxhp);
                        document.getElementById("max-hp-field").value = maxhp;
                        document.getElementById("max-hp-text").innerText = maxhp;
                    });
                    setFromLocalStorageIfNotNull("mp", (mp)=>{
                        mpbar.setAttribute("value", mp);
                        document.getElementById("mp-field").value = mp;
                    });
                    setFromLocalStorageIfNotNull("maxmp", (maxmp)=>{
                        mpbar.setAttribute("max", maxmp);
                        document.getElementById("max-mp-field").value = maxmp;
                        document.getElementById("max-mp-text").innerText = maxmp;
                    });
                    setFromLocalStorageIfNotNull("autosave", (autosave)=>{
                        document.getElementById("autosave-checkbox").checked = (autosave === 'true');  // js weirdness
                    });
                    setFromLocalStorageIfNotNull("lockmax", (lock)=>{
                        setLockMax(lock === 'true');  // js weirdness
                    });
                    checkCrisis()
                }
            }
            function getHpBar() {
                return document.getElementById("hp-bar");
            }
            function getMpBar() {
                return document.getElementById("mp-bar");
            }
            function getAutosave() {
                return document.getElementById("autosave-checkbox").checked;
            }
            function checkCrisis() {
                const hpbar = getHpBar();
                const crisisThreshold = Math.floor(hpbar.getAttribute("max") / 2);
                if (hpbar.getAttribute("value") <= crisisThreshold) {
                    hpbar.className = "hp-crisis";
                }
                else {
                    hpbar.className = "hp";
                }
            }
            function onHpChange(newHp) {
                const hpbar = getHpBar();
                hpbar.setAttribute("value", newHp);
                checkCrisis()
                if (getAutosave()) {
                    save();
                }
            }
            function onMaxHpChange(newHp) {
                const hpbar = getHpBar();
                hpbar.setAttribute("max", newHp);
                document.getElementById("max-hp-text").innerText = newHp;
                checkCrisis()
                if (getAutosave()) {
                    save();
                }
            }
            function onMpChange(newMp) {
                const mpbar = getMpBar();
                mpbar.setAttribute("value", newMp);
                if (getAutosave()) {
                    save();
                }
            }
            function onMaxMpChange(newMp) {
                const mpbar = getMpBar();
                mpbar.setAttribute("max", newMp);
                document.getElementById("max-mp-text").innerText = newMp;
                if (getAutosave()) {
                    save();
                }
            }
            function setLockMax(lock) {
                document.getElementById("max-hp-field").hidden = lock;
                document.getElementById("max-hp-text").hidden = !lock;
                document.getElementById("max-mp-field").hidden = lock;
                document.getElementById("max-mp-text").hidden = !lock;
                document.getElementById("max-lock-button").hidden = lock;
                document.getElementById("max-unlock-button").hidden = !lock;
                if (getAutosave()) {
                    save();
                }
            }
            function onAllow() {
                window.allowLocalStorage = true;
                document.getElementById("localstorage-consent").hidden = true;
                document.getElementById("autosave-span").hidden = false;
            }
            function save() {
                if (!window.allowLocalStorage) {
                    console.error("Trying to save w/o permission");
                }
                else {
                    const hpbar = getHpBar();
                    const mpbar = getMpBar();
                    const ls = window.localStorage;
                    ls.setItem("allowLocalStorage", allowLocalStorage);
                    ls.setItem("hp", hpbar.getAttribute("value"));
                    ls.setItem("maxhp", hpbar.getAttribute("max"));
                    ls.setItem("mp", mpbar.getAttribute("value"));
                    ls.setItem("maxmp", mpbar.getAttribute("max"));
                    ls.setItem("autosave", getAutosave());
                    ls.setItem("lockmax", document.getElementById("max-lock-button").hidden)
                }
            }
        </script>
    </head>
    <body onload="onLoad()">
        <div class="healthbar-spread">
            <div class="right">
                <input type="number" class="three-digits" id="hp-field" value="60" onchange="onHpChange(this.value)">
                /
                <input type="number" class="three-digits" id="max-hp-field" value="60" onchange="onMaxHpChange(this.value)">
                <span id="max-hp-text" hidden>60</span>
            </div>
            <div class="left">
                <progress class="hp" id="hp-bar" value="60" max="60"></progress>
            </div>
        </div>
        <p/>
        <div class="healthbar-spread">
            <div class="right">
                <input type="number" class="three-digits" id="mp-field" value="50" onchange="onMpChange(this.value)">
                /
                <input type="number" class="three-digits" id="max-mp-field" value="50" onchange="onMaxMpChange(this.value)">
                <span id="max-mp-text" hidden>50</span>
            </div>
            <div class="left">
                <progress class="mp" id="mp-bar" value="50" max="50"></progress>
            </div>
        </div>
        <p/>
        <button id="max-lock-button" onclick="setLockMax(true)">Lock max values</button>
        <button id="max-unlock-button" onclick="setLockMax(false)" hidden>Unlock max values</button>
        <p/>
        <button onclick="onAllow(); save();">Save</button>
        <span id="localstorage-consent">
            <i>By using the "Save" feature, you consent to this page using the Local Storage of your browser. No data is ever sent to any server.</i>
        </span>
        <span id="autosave-span" hidden>
            <input type="checkbox" id="autosave-checkbox" onchange="save()"/> <label for="autosave-checkbox"> Autosave</label>
        </span>
    </body>
</html>
